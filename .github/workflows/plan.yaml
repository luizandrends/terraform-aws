name: Terragrunt Plan

on:
  pull_request:
    paths:
      - "**/*.hcl"
jobs:
  terragrunt-plan:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Configure AWS credentials from Test account
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          aws-region: us-east-1
      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Setup OpenTofu
        run: |
          wget https://github.com/opentofu/opentofu/releases/download/v${{ env.OPEN_TF_VERSION }}/tofu_${{ env.OPEN_TF_VERSION }}_linux_amd64.tar.gz
          tar xf tofu_${{ env.OPEN_TF_VERSION }}_linux_amd64.tar.gz
          rm -rf tofu_${{ env.OPEN_TF_VERSION }}_linux_amd64.tar.gz
          mv tofu /usr/local/bin/tofu
          chmod +x /usr/local/bin/tofu
          tofu -v
        env:
          OPEN_TF_VERSION: 1.7.1
      - name: Setup Terragrunt
        uses: autero1/action-terragrunt@v1.1.0
        with:
          terragrunt_version: 0.58.9
      - name: Terragrunt Plan
        id: plan
        run: |
          echo "Running Terragrunt Plan"
          terragrunt run-all plan -no-color > plan.out
      - name: Comment PR
        uses: actions/github-script@v6
        with:
          script: |
            const plan = require('fs').readFileSync('plan.out').toString();
            const message = `
              ## ğŸš€ğŸŒŸ Terragrunt Plan Result ğŸŒŸğŸš€
              Hello there! ğŸ‘‹ The Terragrunt Plan has been executed for your pull request. Here's what we've got:

              \`\`\`yaml
              ${plan}
              \`\`\`

              ğŸ§ Please take a moment to review the plan output above. 

              âœ… If everything looks as expected, feel free to proceed with the merge. 

              â— If anything looks off or unexpected, please make sure to update your changes or discuss with the team.

              Thank you for your contribution! ğŸ‰ğŸ‘

              Happy coding! ğŸ’»ğŸš€
            `;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
